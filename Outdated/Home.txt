import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { createPageUrl } from '../utils';
import { base44 } from '@/api/base44Client';
import { Button } from '@/components/ui/button';
import { Loader2 } from 'lucide-react';
import { 
  Leaf, 
  TreeDeciduous, 
  Users, 
  Shield, 
  ArrowRight,
  CheckCircle2,
  Circle,
  Clock,
  Share2,
  Download
} from 'lucide-react';
import ShareModal from '../components/ShareModal';

export default function Home() {
  const navigate = useNavigate();
  const [company, setCompany] = useState(null);
  const [materialTopics, setMaterialTopics] = useState([]);
  const [loading, setLoading] = useState(true);
  const [readinessScore, setReadinessScore] = useState(0);
  const [gapAnalyses, setGapAnalyses] = useState([]);
  const [actionItems, setActionItems] = useState([]);
  const [documents, setDocuments] = useState([]);
  const [shareModalOpen, setShareModalOpen] = useState(false);
  const [exporting, setExporting] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const user = await base44.auth.me();
      
      if (!user?.company_id) {
        navigate(createPageUrl('CompanySetup'));
        return;
      }

      const companies = await base44.entities.Company.filter({ id: user.company_id });
      if (companies.length > 0) {
        setCompany(companies[0]);
      }

      const topics = await base44.entities.MaterialTopic.filter({ company_id: user.company_id });
      setMaterialTopics(topics);

      // Load gap analyses to calculate progress
      const analyses = await base44.entities.GapAnalysis.filter({ company_id: user.company_id });
      setGapAnalyses(analyses);

      // Load action items and documents for stats
      const items = await base44.entities.ActionItem.filter({ company_id: user.company_id });
      setActionItems(items);

      const docs = await base44.entities.Document.filter({ company_id: user.company_id });
      setDocuments(docs);
      
      // Calculate readiness score based on completed steps
      let score = 0;
      if (topics.length > 0) score += 20; // Materiality assessment completed
      
      // Add points for gap analysis completion (up to 40 points)
      if (topics.length > 0 && analyses.length > 0) {
        const assessedTopics = analyses.filter(a => a.rag_status).length;
        const completionRate = assessedTopics / topics.length;
        score += Math.round(completionRate * 40);
      }
      
      setReadinessScore(score);

    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const getCategoryProgress = (categoryTopics) => {
    if (categoryTopics.length === 0) return 0;
    const assessedCount = categoryTopics.filter(topic => 
      gapAnalyses.some(a => a.topic_id === topic.id && a.rag_status)
    ).length;
    return Math.round((assessedCount / categoryTopics.length) * 100);
  };

  const handleExportPDF = async () => {
    setExporting(true);
    try {
      // Prepare data
      const eTopics = materialTopics.filter(t => t.topic_code?.startsWith('E'));
      const sTopics = materialTopics.filter(t => t.topic_code?.startsWith('S'));
      const gTopics = materialTopics.filter(t => t.topic_code?.startsWith('G'));

      const eProgress = getCategoryProgress(eTopics);
      const sProgress = getCategoryProgress(sTopics);
      const gProgress = getCategoryProgress(gTopics);

      // Create printable HTML
      const topicsWithStatus = materialTopics.map(topic => {
        const analysis = gapAnalyses.find(a => a.topic_id === topic.id);
        return {
          code: topic.topic_code,
          name: topic.topic_name,
          status: analysis?.rag_status || 'Not assessed'
        };
      });

      const reportHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>ESG Passport Report - ${company?.name}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; color: #2D5016; }
            .header { border-bottom: 3px solid #7CB342; padding-bottom: 20px; margin-bottom: 30px; }
            .header h1 { margin: 0; color: #2D5016; }
            .header .date { color: #666; margin-top: 10px; }
            .score-section { background: #f8faf5; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
            .score-section h2 { font-size: 48px; color: #7CB342; margin: 10px 0; }
            .categories { display: flex; gap: 20px; margin-bottom: 30px; }
            .category { flex: 1; padding: 20px; background: white; border: 2px solid #e8f0e0; border-radius: 10px; }
            .category h3 { margin: 0 0 10px 0; }
            .progress-bar { height: 8px; background: #e8f0e0; border-radius: 4px; overflow: hidden; }
            .progress-fill { height: 100%; background: linear-gradient(to right, #2D5016, #7CB342); }
            .topics-section { margin-bottom: 30px; }
            .topic { padding: 15px; margin-bottom: 10px; border-left: 4px solid #7CB342; background: #f8faf5; }
            .topic-header { font-weight: bold; margin-bottom: 5px; }
            .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
            .status-green { background: #d1f4d1; color: #2d5016; }
            .status-amber { background: #fff4d1; color: #8b6914; }
            .status-red { background: #ffd1d1; color: #8b1414; }
            .stats-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
            .stat { text-align: center; padding: 20px; background: white; border: 2px solid #e8f0e0; border-radius: 10px; }
            .stat-value { font-size: 32px; font-weight: bold; color: #2D5016; }
            .stat-label { color: #666; margin-top: 5px; }
            @media print {
              body { padding: 20px; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>üçÉ ${company?.name || 'Company'}</h1>
            <div class="date">ESG Passport Report - Generated ${new Date().toLocaleDateString()}</div>
          </div>

          <div class="score-section">
            <div style="color: #666; font-size: 18px;">CSRD Readiness Score</div>
            <h2>${readinessScore}%</h2>
            <div style="color: #666;">Overall Compliance Progress</div>
          </div>

          <div class="categories">
            <div class="category">
              <h3>üå≥ Environmental</h3>
              <div style="font-size: 24px; font-weight: bold; color: #2D5016; margin: 10px 0;">${eProgress}%</div>
              <div class="progress-bar"><div class="progress-fill" style="width: ${eProgress}%"></div></div>
              <div style="color: #666; margin-top: 10px; font-size: 14px;">${eTopics.length} topics</div>
            </div>
            <div class="category">
              <h3>üë• Social</h3>
              <div style="font-size: 24px; font-weight: bold; color: #2D5016; margin: 10px 0;">${sProgress}%</div>
              <div class="progress-bar"><div class="progress-fill" style="width: ${sProgress}%"></div></div>
              <div style="color: #666; margin-top: 10px; font-size: 14px;">${sTopics.length} topics</div>
            </div>
            <div class="category">
              <h3>üõ°Ô∏è Governance</h3>
              <div style="font-size: 24px; font-weight: bold; color: #2D5016; margin: 10px 0;">${gProgress}%</div>
              <div class="progress-bar"><div class="progress-fill" style="width: ${gProgress}%"></div></div>
              <div style="color: #666; margin-top: 10px; font-size: 14px;">${gTopics.length} topics</div>
            </div>
          </div>

          <div class="topics-section">
            <h2 style="margin-bottom: 20px;">Material Topics Assessment</h2>
            ${topicsWithStatus.map(topic => `
              <div class="topic">
                <div class="topic-header">${topic.code}: ${topic.name}</div>
                <span class="status-badge status-${topic.status === 'green' ? 'green' : topic.status === 'amber' ? 'amber' : topic.status === 'red' ? 'red' : 'amber'}">
                  ${topic.status === 'Not assessed' ? 'Not Assessed' : topic.status.toUpperCase()}
                </span>
              </div>
            `).join('')}
          </div>

          <div class="stats-section">
            <div class="stat">
              <div class="stat-value">${documents.length}</div>
              <div class="stat-label">Documents</div>
            </div>
            <div class="stat">
              <div class="stat-value">${actionItems.filter(t => t.status === 'done').length}/${actionItems.length}</div>
              <div class="stat-label">Tasks Done</div>
            </div>
            <div class="stat">
              <div class="stat-value">${gapAnalyses.filter(a => a.rag_status).length}/${materialTopics.length}</div>
              <div class="stat-label">Topics Assessed</div>
            </div>
            <div class="stat">
              <div class="stat-value">${materialTopics.length}</div>
              <div class="stat-label">Material Topics</div>
            </div>
          </div>

          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e8f0e0; text-align: center; color: #666; font-size: 12px;">
            Generated by ESG Passport - CSRD Compliance Platform
          </div>

          <script>
            window.onload = function() {
              window.print();
            }
          </script>
        </body>
        </html>
      `;

      // Open in new window and trigger print
      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportHTML);
      printWindow.document.close();
    } catch (error) {
      console.error('Error exporting:', error);
      alert('Failed to generate report. Please try again.');
    } finally {
      setExporting(false);
    }
  };

  const categories = [
    {
      title: 'Environmental',
      icon: TreeDeciduous,
      color: 'from-emerald-500 to-green-600',
      bgColor: 'bg-emerald-50',
      topics: materialTopics.filter(t => t.topic_code?.startsWith('E'))
    },
    {
      title: 'Social',
      icon: Users,
      color: 'from-blue-500 to-cyan-600',
      bgColor: 'bg-blue-50',
      topics: materialTopics.filter(t => t.topic_code?.startsWith('S'))
    },
    {
      title: 'Governance',
      icon: Shield,
      color: 'from-purple-500 to-indigo-600',
      bgColor: 'bg-purple-50',
      topics: materialTopics.filter(t => t.topic_code?.startsWith('G'))
    }
  ];

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="animate-pulse flex items-center gap-3">
          <Leaf className="w-8 h-8 text-[#2D5016]" />
          <span className="text-[#2D5016] font-medium">Loading...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-8">
      {/* Header */}
      <div className="glass-card rounded-2xl p-8">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div className="flex-1">
            <h1 className="text-3xl font-bold text-[#2D5016]">
              Welcome, {company?.name}
            </h1>
            <p className="text-[#2D5016]/70 mt-2">
              Track your CSRD compliance journey
            </p>
          </div>

          {/* Action Buttons */}
          <div className="flex items-center gap-3">
            <Button
              onClick={() => setShareModalOpen(true)}
              variant="outline"
              className="h-10 px-4 border-[#2D5016]/20 text-[#2D5016] hover:bg-[#2D5016]/10"
            >
              <Share2 className="w-4 h-4 mr-2" />
              Share
            </Button>
            <Button
              onClick={handleExportPDF}
              disabled={exporting}
              className="h-10 px-4 bg-gradient-to-r from-[#2D5016] to-[#3d6b1e] hover:from-[#3d6b1e] hover:to-[#4d7b2e] text-white"
            >
              {exporting ? (
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              ) : (
                <Download className="w-4 h-4 mr-2" />
              )}
              Export Report
            </Button>
          </div>
          
          {/* Progress Ring */}
          <div className="flex items-center gap-6">
            <div className="relative w-32 h-32">
              <svg className="w-32 h-32 transform -rotate-90">
                <circle
                  cx="64"
                  cy="64"
                  r="56"
                  stroke="currentColor"
                  strokeWidth="12"
                  fill="none"
                  className="text-[#2D5016]/10"
                />
                <circle
                  cx="64"
                  cy="64"
                  r="56"
                  stroke="url(#progressGradient)"
                  strokeWidth="12"
                  fill="none"
                  strokeLinecap="round"
                  strokeDasharray={`${readinessScore * 3.52} 352`}
                  className="transition-all duration-1000 ease-out"
                />
                <defs>
                  <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#2D5016" />
                    <stop offset="100%" stopColor="#7CB342" />
                  </linearGradient>
                </defs>
              </svg>
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="text-center">
                  <span className="text-3xl font-bold text-[#2D5016]">{readinessScore}%</span>
                  <p className="text-xs text-[#2D5016]/60">Ready</p>
                </div>
              </div>
            </div>
            <div className="hidden md:block">
              <p className="text-lg font-semibold text-[#2D5016]">CSRD Readiness</p>
              <p className="text-sm text-[#2D5016]/60 mt-1">
                {readinessScore === 0 ? 'Start your assessment' : 'Keep going!'}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Category Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {categories.map((category) => {
          const progress = getCategoryProgress(category.topics);
          return (
            <div key={category.title} className="glass-card rounded-2xl p-6 hover:shadow-lg transition-all duration-300">
              <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${category.color} flex items-center justify-center mb-4`}>
                <category.icon className="w-6 h-6 text-white" />
              </div>
              <h3 className="text-xl font-semibold text-[#2D5016] mb-2">{category.title}</h3>
              
              {category.topics.length > 0 ? (
                <>
                  <div className="space-y-2 mt-4 mb-4">
                    {category.topics.map((topic) => {
                      const hasAnalysis = gapAnalyses.some(a => a.topic_id === topic.id && a.rag_status);
                      return (
                        <div key={topic.id} className="flex items-center gap-2 text-sm">
                          {hasAnalysis ? (
                            <CheckCircle2 className="w-4 h-4 text-[#7CB342]" />
                          ) : (
                            <Circle className="w-4 h-4 text-[#2D5016]/30" />
                          )}
                          <span className="text-[#2D5016]/80">{topic.topic_code}: {topic.topic_name}</span>
                        </div>
                      );
                    })}
                  </div>
                  <div className="mt-4 pt-4 border-t border-[#2D5016]/10">
                    <div className="flex items-center justify-between text-sm mb-2">
                      <span className="text-[#2D5016]/60">Progress</span>
                      <span className="font-medium text-[#2D5016]">{progress}%</span>
                    </div>
                    <div className="h-2 bg-[#2D5016]/10 rounded-full overflow-hidden">
                      <div 
                        className={`h-full bg-gradient-to-r ${category.color} transition-all duration-500`}
                        style={{ width: `${progress}%` }}
                      />
                    </div>
                  </div>
                </>
              ) : (
                <div className="flex items-center gap-2 text-sm text-[#2D5016]/50 mt-4">
                  <Circle className="w-4 h-4" />
                  <span>No topics identified yet</span>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Get Started CTA */}
      {materialTopics.length === 0 && (
        <div className="glass-card rounded-2xl p-8 text-center">
          <div className="max-w-md mx-auto">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-[#2D5016] to-[#7CB342] flex items-center justify-center mx-auto mb-4">
              <Leaf className="w-8 h-8 text-white" />
            </div>
            <h2 className="text-2xl font-bold text-[#2D5016] mb-2">
              Start Your ESG Journey
            </h2>
            <p className="text-[#2D5016]/70 mb-6">
              Begin with a quick materiality assessment to identify which sustainability topics are most relevant for your business.
            </p>
            <Link to={createPageUrl('MaterialityAssessment')}>
              <Button className="h-12 px-8 bg-gradient-to-r from-[#2D5016] to-[#3d6b1e] hover:from-[#3d6b1e] hover:to-[#4d7b2e] text-white font-medium rounded-xl shadow-lg shadow-[#2D5016]/20 transition-all duration-200">
                Get Started
                <ArrowRight className="w-5 h-5 ml-2" />
              </Button>
            </Link>
          </div>
        </div>
      )}

      {/* Quick Stats */}
      {materialTopics.length > 0 && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Next Steps */}
          <div className="glass-card rounded-2xl p-6">
            <h3 className="text-lg font-semibold text-[#2D5016] mb-4">Next Steps</h3>
            {actionItems.filter(t => t.status !== 'done').slice(0, 3).length > 0 ? (
              <div className="space-y-3">
                {actionItems
                  .filter(t => t.status !== 'done')
                  .sort((a, b) => {
                    const priorityOrder = { high: 0, medium: 1, low: 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                  })
                  .slice(0, 3)
                  .map((task) => (
                    <Link
                      key={task.id}
                      to={createPageUrl('ActionPlan')}
                      className="block p-3 rounded-lg hover:bg-white/50 transition-colors"
                    >
                      <div className="flex items-start gap-3">
                        <Circle className="w-4 h-4 text-[#2D5016]/40 mt-0.5" />
                        <div className="flex-1">
                          <p className="text-sm font-medium text-[#2D5016]">{task.task_name}</p>
                          {task.due_date && (
                            <p className="text-xs text-[#2D5016]/60 mt-1">
                              Due {new Date(task.due_date).toLocaleDateString()}
                            </p>
                          )}
                        </div>
                        <span className={cn(
                          "px-2 py-1 text-xs rounded-full",
                          task.priority === 'high' ? 'bg-red-100 text-red-700' :
                          task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-blue-100 text-blue-700'
                        )}>
                          {task.priority}
                        </span>
                      </div>
                    </Link>
                  ))}
              </div>
            ) : (
              <p className="text-sm text-[#2D5016]/60">No pending tasks</p>
            )}
          </div>

          {/* Upcoming Deadlines */}
          <div className="glass-card rounded-2xl p-6">
            <h3 className="text-lg font-semibold text-[#2D5016] mb-4">Upcoming Deadlines</h3>
            {actionItems.filter(t => t.due_date && t.status !== 'done').slice(0, 3).length > 0 ? (
              <div className="space-y-3">
                {actionItems
                  .filter(t => t.due_date && t.status !== 'done')
                  .sort((a, b) => new Date(a.due_date) - new Date(b.due_date))
                  .slice(0, 3)
                  .map((task) => {
                    const isOverdue = new Date(task.due_date) < new Date();
                    return (
                      <Link
                        key={task.id}
                        to={createPageUrl('ActionPlan')}
                        className="block p-3 rounded-lg hover:bg-white/50 transition-colors"
                      >
                        <div className="flex items-start gap-3">
                          <Clock className={cn(
                            "w-4 h-4 mt-0.5",
                            isOverdue ? "text-red-500" : "text-[#2D5016]/40"
                          )} />
                          <div className="flex-1">
                            <p className="text-sm font-medium text-[#2D5016]">{task.task_name}</p>
                            <p className={cn(
                              "text-xs mt-1",
                              isOverdue ? "text-red-600 font-medium" : "text-[#2D5016]/60"
                            )}>
                              {isOverdue ? 'Overdue: ' : ''}{new Date(task.due_date).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                      </Link>
                    );
                  })}
              </div>
            ) : (
              <p className="text-sm text-[#2D5016]/60">No upcoming deadlines</p>
            )}
          </div>
        </div>
      )}

      {/* Stats Summary */}
      {materialTopics.length > 0 && (
        <div className="glass-card rounded-2xl p-6">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div>
              <p className="text-sm text-[#2D5016]/60 mb-1">Documents Uploaded</p>
              <p className="text-2xl font-bold text-[#2D5016]">{documents.length}</p>
            </div>
            <div>
              <p className="text-sm text-[#2D5016]/60 mb-1">Tasks Completed</p>
              <p className="text-2xl font-bold text-[#2D5016]">
                {actionItems.filter(t => t.status === 'done').length} / {actionItems.length}
              </p>
            </div>
            <div>
              <p className="text-sm text-[#2D5016]/60 mb-1">Topics Assessed</p>
              <p className="text-2xl font-bold text-[#2D5016]">
                {gapAnalyses.filter(a => a.rag_status).length} / {materialTopics.length}
              </p>
            </div>
            <div>
              <p className="text-sm text-[#2D5016]/60 mb-1">Overall Progress</p>
              <p className="text-2xl font-bold text-[#7CB342]">{readinessScore}%</p>
            </div>
          </div>
        </div>
      )}

      {/* Progress Steps */}
      {materialTopics.length > 0 && (
        <div className="glass-card rounded-2xl p-8">
          <h3 className="text-xl font-semibold text-[#2D5016] mb-6">Your Progress</h3>
          <div className="space-y-4">
            {[
              { name: 'Materiality Assessment', completed: materialTopics.length > 0, page: 'MaterialityAssessment' },
              { 
                name: 'Gap Analysis', 
                completed: materialTopics.length > 0 && gapAnalyses.filter(a => a.rag_status).length === materialTopics.length, 
                page: 'GapAnalysis' 
              },
              { 
                name: 'Action Plan', 
                completed: actionItems.length > 0 && actionItems.filter(t => t.status === 'done').length === actionItems.length, 
                page: 'ActionPlan' 
              },
              { 
                name: 'Document Collection', 
                completed: documents.length >= materialTopics.length, 
                page: 'DocumentHub' 
              },
            ].map((step, index) => (
              <Link 
                key={step.name}
                to={createPageUrl(step.page)}
                className="flex items-center gap-4 p-4 rounded-xl hover:bg-[#2D5016]/5 transition-colors"
              >
                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                  step.completed 
                    ? 'bg-gradient-to-br from-[#2D5016] to-[#7CB342]' 
                    : 'bg-[#2D5016]/10'
                }`}>
                  {step.completed ? (
                    <CheckCircle2 className="w-5 h-5 text-white" />
                  ) : (
                    <span className="text-[#2D5016]/50 font-medium">{index + 1}</span>
                  )}
                </div>
                <div className="flex-1">
                  <p className={`font-medium ${step.completed ? 'text-[#2D5016]' : 'text-[#2D5016]/60'}`}>
                    {step.name}
                  </p>
                </div>
                <ArrowRight className={`w-5 h-5 ${step.completed ? 'text-[#7CB342]' : 'text-[#2D5016]/30'}`} />
              </Link>
            ))}
          </div>
        </div>
      )}

      <style>{`
        .glass-card {
          background: rgba(255, 255, 255, 0.7);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.5);
        }
      `}</style>

      {/* Share Modal */}
      <ShareModal 
        open={shareModalOpen} 
        onOpenChange={setShareModalOpen}
        companyId={company?.id}
      />
    </div>
  );
}